<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
<title>我要小笋尖挑战赛</title>

    <script src="lib/easeljs-0.7.1.min.js"></script>
    <script src="lib/tweenjs-0.5.1.min.js"></script>
    <script src="lib/movieclip-0.7.1.min.js"></script>
    <script src="lib/preloadjs-0.4.1.min.js"></script>
    <script src="S90Game.js?r=20141022-6"></script>


    <script>
        var canvas, stage, exportRoot;
        var loadingMc;//加载
        var count=0;//loading百分比
        var tipsTxt;//提示文本
        var manifest;//图片加载列表


        var isWap;
        var isGameOver=false;
        var p1,p2,p3,end,random;
        var t;//计时器
        var tCount=0;
        var randomArr=new Array();
        var score=0;


        //框架代码--------
        function init() {

            canvas = document.getElementById("canvas");
            images = images||{};

            manifest = [
                {src:"images/bg.jpg", id:"bg"},
                {src:"images/btnx.png", id:"btnx"},
                {src:"images/end.jpg", id:"end"},
                {src:"images/p11.png", id:"p11"},
                {src:"images/p12.png", id:"p12"},
                {src:"images/p13.png", id:"p13"},
                {src:"images/p14.png", id:"p14"},
                {src:"images/p15.png", id:"p15"},
                {src:"images/p17.png", id:"p17"},
                {src:"images/p18.jpg", id:"p18"},
                {src:"images/p21.png", id:"p21"},
                {src:"images/p22.jpg", id:"p22"},
                {src:"images/shareTips.png", id:"shareTips"},
                {src:"images/sun.png", id:"sun"},
                {src:"images/wajueji1.png", id:"wajueji1"},
                {src:"images/wajueji2.png", id:"wajueji2"},
                {src:"images/wajueji3.png", id:"wajueji3"}
            ];

            var loader = new createjs.LoadQueue(false);
            loader.addEventListener("fileload", handleFileLoad);
            loader.addEventListener("complete", handleComplete);
            loader.loadManifest(manifest);

            stage = new createjs.Stage(canvas);
            createjs.Ticker.setFPS(60);
            createjs.Ticker.addEventListener("tick", stage);
        }
        function handleFileLoad(evt) {
            if (evt.item.type == "image") { images[evt.item.id] = evt.result; }
            count++;
            //loadingMc.Ntext.text=String(Math.floor(count/manifest.length*100))+"%";
            loadingMc=document.getElementById('loading');
            loadingMc.innerHTML=String(Math.floor(count/manifest.length*100))+"%";
        }

        function handleComplete() {
        	//清除loading
            loadingMc.style.display='none';
			//stage.removeChild(loadingMc);
            exportRoot = new lib.S90Game();
            stage.addChild(exportRoot);
            stage.update();
            stage.enableMouseOver();

            myscript();//自已的代码
        }

        //自己的代码-------
        function myscript(){
            iniEvent();
            checkDevice();
            iniP1();
            exportRoot.btn_ad.addEventListener('click',linkClickHandle);
        }
        //初始化p1
        function iniP1(){
            p1 = new lib.P1();
            exportRoot.addChild(p1);
            stage.update();
            p1.btn_play.addEventListener('click',playClickHandle);
        }
        function removeP(p){
            exportRoot.removeChild(p);
        }
        //初始化p2
        function iniP2(){
            //alert('5');
            p2 = new lib.P2();
            //alert('p2');
            exportRoot.addChild(p2);
            iniBoxname();

            //开始计时
            p2.time_bar.gotoAndPlay(1);
            //p2.time_bar.bar_over.mask=p2.time_bar.bar;
            //createjs.Tween.get(p2.time_bar.wajueji).to({x:0}, 1800).call(timeEnd);
            //createjs.Tween.get(p2.time_bar.yan).to({x:13.65}, 1800);
            //createjs.Tween.get(p2.time_bar.bar).to({scaleX:1}, 1800);
            timedCount();
        }
        function iniBoxname(){
            p2.b1.name='b1';
            p2.b2.name='b2';
            p2.b3.name='b3';
            p2.b4.name='b4';
            p2.b5.name='b5';
            p2.b6.name='b6';
            p2.b7.name='b7';
            p2.b8.name='b8';
            p2.b9.name='b9';
            p2.b10.name='b10';
            p2.b11.name='b11';
            p2.b12.name='b12';
        }
        function iniEnd(){
            end = new lib.End();
            end.x=640/2;
            end.y=1008/2;

            exportRoot.addChild(end);
            stage.update();
            end.btn_close.addEventListener('click',closeClickHandle);
            function closeClickHandle(evt){
                if(checkPointID(evt)) {
                    replay();
                }
            }
            end.score.text=String(score);
            //shareTitleTxt='我找到了'+String(score)+'个小笋尖，获得挖掘能手称号，超越全国'+Math.floor(score/tCount*100)+'%的玩家!';
            shareTitleTxt='我找到了'+String(score)+'个小笋尖荣获挖掘机能手称号，你也来试试。';

            dataForWeixin.title=shareTitleTxt;
        }
        //重玩一次
        function replay(){
            removeP(p2);
            removeP(end);
            //重置变量
            isGameOver=false;
            tCount=0;
            randomArr=new Array();
            score=0;
            iniP1();
        }
        function timedCount(){
            if(!isGameOver){
                tCount++;
                //console.log(p2.time_bar.currentFrame);
                createBox();
                t=setTimeout(timedCount,800-Math.floor(p2.time_bar.currentFrame/2.5));
            }else{
                console.log('时间到');
                setTimeout(iniEnd,2000);
            }
        }
        //生成笋子
        function createBox(){
            if(randomNum()){
                var box=new lib.Box();
                box.x=p2.getChildByName('b'+String(random)).x;
                box.y=p2.getChildByName('b'+String(random)).y;
                p2.addChild(box);
                box.hit.addEventListener('click',boxClickHandle);
                setTimeout(function () {
                    if(box!=null){
                        p2.removeChild(box);box=null;
                    }
                }, 3000-p2.time_bar.currentFrame);
                function boxClickHandle(evt){
                    if(checkPointID(evt)) {
                        score++;
                        p2.score.text = String(score);
                        box.play();
                        setTimeout(function () {
                            p2.removeChild(box);
                            box = null;
                        }, 1000);
                    }
                }
                return;
            }else{
                createBox();
            }
        }
        function randomNum(){
            random=Math.floor(Math.random()*12+1);
            //console.log('random='+random);
            if(searchRandomArr(random,randomArr)){
                randomArr.push(random);
                if(randomArr.length>8){
                    randomArr.shift();
                }
                return true;
            }else{
                //console.log('数字重复，重新生成随机数');
                return false;
            }
        }
        function searchRandomArr(r,arr){
            for(var i=0;i<arr.length; i++){
                if(r==arr[i]){
                    return false;
                }
            }
            return true;
        }
        //----------事件-----------
        function iniEvent(){
            stage.addEventListener("stagemousedown",stageclickHandle);
            function stageclickHandle(event){
                event.preventDefault();
            }
            if (createjs.Touch.isSupported()) {
                createjs.Touch.enable(stage);
            }

        }
        function timeEnd(){
            //游戏时间结束
            //alert('game over');
            isGameOver=true;
        }
        //----------按钮-----------
        function playClickHandle(evt){
            if(checkPointID(evt)) {
                removeP(p1);
                iniP2();
            }
        }
        function linkClickHandle(evt){
            if(checkPointID(evt)) {
                window.open('http://www.lefen.cn/index.php?app=brand&mod=Index&act=detail&product_id=19', '_blank');
            }
        }

        //----------终端检测------
        function checkDevice(){
            if (!navigator.userAgent.match(/mobile/i)) {
                //alert("当前设备为pc");
                isWap=false;
            }else{
                //alert("当前设备为移动");
                isWap=true;
            }
        }
        function checkPointID(evt){
            if(isWap){
                if(evt.pointerID!=-1){
                    return true;
                }else{
                    return false;
                }
            }else{
                if(evt.pointerID==-1){
                    return true;
                }else{
                    return false;
                }
            }
        }
    </script>
<style>
    html,body{ width:100%;height:100%;}
    body{margin:0px;padding:0px;text-align:center; font-size: 100%;}
    canvas{position: absolute; left:0; top:0; z-index: 1; width:100%; height:100%; display:inline-block;}
    #loading{position: absolute;z-index: 2; left:50%; top:50%; margin-left: -20px; font-size: 100%; font-family: arial, "Hiragino Sans GB", "Microsoft Yahei", sans-serif; color: #666666;}
</style>
</head>

<body onload="init();" style="background-color:#fff">
<canvas id="canvas" width="640" height="1008" style="background-color:#fff"></canvas>
<div id="loading"></div>
<div style="display: none">
    <script type="text/javascript">
        var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
        document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F51741c17f6d6fb8cd3a6478facbba45a' type='text/javascript'%3E%3C/script%3E"));
    </script>
</div>

</body>
<script>
    //自定义微信分享

    var dataForWeixin={
        appId:"",
        MsgImg:"http://s90.lenovo-apps.com/S90Game/images/share.jpg",
        TLImg:"http://s90.lenovo-apps.com/S90Game/images/share.jpg",
        url:"http://s90.lenovo-apps.com/S90Game/index.html",
        title:"我要小笋尖-兰翔挑战赛",
        desc:"全国各地惊现无数小笋尖，我们一起把TA们找出来!",
        fakeid:"",
        callback:function(){}
    };
    (function(){
        var onBridgeReady=function(){
            WeixinJSBridge.on('menu:share:appmessage', function(argv){
                WeixinJSBridge.invoke('sendAppMessage',{
                    "appid":dataForWeixin.appId,
                    "img_url":dataForWeixin.MsgImg,
                    "img_width":"120",
                    "img_height":"120",
                    "link":dataForWeixin.url,
                    "desc":dataForWeixin.desc,
                    "title":dataForWeixin.title
                }, function(res){(dataForWeixin.callback)();});
            });
            WeixinJSBridge.on('menu:share:timeline', function(argv){
                (dataForWeixin.callback)();
                WeixinJSBridge.invoke('shareTimeline',{
                    "img_url":dataForWeixin.TLImg,
                    "img_width":"120",
                    "img_height":"120",
                    "link":dataForWeixin.url,
                    "desc":dataForWeixin.desc,
                    "title":dataForWeixin.title
                }, function(res){});
            });
            WeixinJSBridge.on('menu:share:weibo', function(argv){
                WeixinJSBridge.invoke('shareWeibo',{
                    "content":dataForWeixin.title,
                    "url":dataForWeixin.url
                }, function(res){(dataForWeixin.callback)();});
            });
            WeixinJSBridge.on('menu:share:facebook', function(argv){
                (dataForWeixin.callback)();
                WeixinJSBridge.invoke('shareFB',{
                    "img_url":dataForWeixin.TLImg,
                    "img_width":"120",
                    "img_height":"120",
                    "link":dataForWeixin.url,
                    "desc":dataForWeixin.desc,
                    "title":dataForWeixin.title
                }, function(res){});
            });
        };
        if(document.addEventListener){
            document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
        }else if(document.attachEvent){
            document.attachEvent('WeixinJSBridgeReady'   , onBridgeReady);
            document.attachEvent('onWeixinJSBridgeReady' , onBridgeReady);
        }
    })();

    document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
        WeixinJSBridge.call('hideToolbar');
    });


</script>
<div style="display:none">
<script src="http://s6.cnzz.com/z_stat.php?id=1253448732&web_id=1253448732" language="JavaScript"></script>
</div>
</html>
